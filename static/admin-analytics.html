<!DOCTYPE html>
<html>
  <head>
    <title>Admin Analytics - L.Kamero.ai</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
        background: #f8f9fa;
        line-height: 1.6;
      }

      .header {
        background: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      }

      .header h1 {
        margin: 0 0 20px 0;
        color: #2c3e50;
        font-size: 2.5rem;
        font-weight: 700;
      }

      .nav-links {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .nav-links a {
        color: #007bff;
        text-decoration: none;
        padding: 12px 20px;
        border-radius: 8px;
        border: 2px solid #007bff;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .nav-links a:hover {
        background: #007bff;
        color: white;
        transform: translateY(-1px);
      }

      .nav-links a.active {
        background: #007bff;
        color: white;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        text-align: center;
        transition: transform 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #007bff, #0056b3);
      }

      .stat-card:hover {
        transform: translateY(-2px);
      }

      .stat-number {
        font-size: 2.5em;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 8px;
        display: block;
      }

      .stat-label {
        color: #6c757d;
        font-size: 0.95em;
        font-weight: 500;
      }

      .stat-change {
        font-size: 0.8em;
        margin-top: 5px;
        font-weight: 600;
      }

      .stat-change.positive {
        color: #28a745;
      }

      .stat-change.negative {
        color: #dc3545;
      }

      .charts-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .chart-card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      }

      .chart-title {
        font-size: 1.3em;
        font-weight: 600;
        margin-bottom: 20px;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .chart-icon {
        width: 24px;
        height: 24px;
        background: #007bff;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
      }

      .platform-chart {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .chart-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
      }

      .chart-label {
        min-width: 80px;
        font-weight: 500;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .platform-icon {
        width: 16px;
        height: 16px;
        border-radius: 3px;
      }

      .chart-bar {
        flex: 1;
        height: 25px;
        background: #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
      }

      .chart-fill {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #0056b3);
        border-radius: 12px;
        transition: width 0.8s ease;
        position: relative;
      }

      .chart-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3)
        );
      }

      .chart-value {
        min-width: 80px;
        text-align: right;
        font-weight: 600;
        color: #495057;
        font-size: 0.9em;
      }

      .performance-overview {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .performance-metric {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .performance-value {
        font-size: 1.8em;
        font-weight: 700;
        color: #28a745;
        margin-bottom: 5px;
      }

      .performance-label {
        font-size: 0.9em;
        color: #6c757d;
      }

      .urls-section {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      }

      .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        gap: 15px;
        flex-wrap: wrap;
      }

      .controls-left {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .controls-right {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .search-box {
        padding: 12px 16px;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 14px;
        min-width: 300px;
        transition: border-color 0.3s ease;
      }

      .search-box:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      }

      .filter-select {
        padding: 12px 16px;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        cursor: pointer;
      }

      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn:hover {
        background: #0056b3;
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-secondary:hover {
        background: #545b62;
      }

      .btn-success {
        background: #28a745;
      }

      .btn-success:hover {
        background: #218838;
      }

      .url-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .url-table th,
      .url-table td {
        padding: 16px 12px;
        text-align: left;
        border-bottom: 1px solid #e1e8ed;
      }

      .url-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #2c3e50;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .url-table tr:hover {
        background: #f8f9fa;
      }

      .url-code {
        font-family: "Monaco", "Consolas", monospace;
        background: #e9ecef;
        padding: 6px 10px;
        border-radius: 6px;
        color: #007bff;
        font-size: 12px;
        font-weight: 600;
      }

      .url-original {
        max-width: 350px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: #495057;
      }

      .click-count {
        font-weight: 700;
        color: #28a745;
        font-size: 1.1em;
      }

      .api-badge {
        background: #17a2b8;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: 600;
      }

      .web-badge {
        background: #6c757d;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: 600;
      }

      .platform-stats {
        font-size: 0.85em;
        color: #6c757d;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .action-links {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .action-links a {
        color: #007bff;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9em;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background 0.3s ease;
      }

      .action-links a:hover {
        background: #e3f2fd;
        text-decoration: none;
      }

      .copy-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        margin-left: 8px;
        transition: background 0.3s ease;
      }

      .copy-btn:hover {
        background: #218838;
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 30px;
      }

      .pagination button {
        padding: 10px 15px;
        border: 2px solid #e1e8ed;
        background: white;
        cursor: pointer;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .pagination button:hover:not(:disabled) {
        background: #f8f9fa;
        border-color: #007bff;
      }

      .pagination button.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
      }

      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .loading {
        text-align: center;
        padding: 60px;
        color: #6c757d;
        font-size: 1.1em;
      }

      .loading::after {
        content: "";
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .copy-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .copy-notification.show {
        transform: translateX(0);
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
      }

      .empty-state h3 {
        margin-bottom: 10px;
        color: #6c757d;
      }

      .refresh-indicator {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #ffffff;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .auto-refresh-info {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        padding: 10px 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 0.9em;
        color: #1976d2;
      }

      @media (max-width: 1200px) {
        .charts-section {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .header {
          padding: 20px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .nav-links {
          flex-direction: column;
        }

        .controls {
          flex-direction: column;
          align-items: stretch;
        }

        .controls-left,
        .controls-right {
          justify-content: center;
        }

        .search-box {
          min-width: auto;
          width: 100%;
        }

        .url-table {
          font-size: 14px;
        }

        .url-table th,
        .url-table td {
          padding: 12px 8px;
        }

        .url-original {
          max-width: 200px;
        }

        .stats-grid {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .performance-overview {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üìä Admin Analytics Dashboard</h1>
      <div class="nav-links">
        <a href="/admin">üîë API Keys Management</a>
        <a href="/admin/analytics">üìä All URLs Analytics</a>
        <a href="/dashboard">üìà Individual URL Analytics</a>
        <a href="/">üè† URL Shortener</a>
      </div>
    </div>

    <div class="auto-refresh-info">
      ‚ÑπÔ∏è Dashboard automatically refreshes every 60 seconds to show the latest
      data.
    </div>

    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-number" id="totalUrls">-</div>
        <div class="stat-label">Total URLs</div>
        <div class="stat-change" id="urlsChange"></div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalClicks">-</div>
        <div class="stat-label">Total Clicks</div>
        <div class="stat-change" id="clicksChange"></div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="urlsToday">-</div>
        <div class="stat-label">URLs Created Today</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="clicksToday">-</div>
        <div class="stat-label">Clicks Today</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="urlsWithApi">-</div>
        <div class="stat-label">URLs with API Key</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="urlsWithoutApi">-</div>
        <div class="stat-label">URLs without API Key</div>
      </div>
    </div>

    <div class="charts-section">
      <div class="chart-card">
        <div class="chart-title">
          <div class="chart-icon">üì±</div>
          Top Platforms
        </div>
        <div class="platform-chart" id="platformChart">
          <div class="loading">Loading platform data</div>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-title">
          <div class="chart-icon">‚ö°</div>
          Performance Overview
        </div>
        <div class="performance-overview" id="performanceChart">
          <div class="performance-metric">
            <div class="performance-value" id="successRate">99.9%</div>
            <div class="performance-label">Success Rate</div>
          </div>
          <div class="performance-metric">
            <div class="performance-value" id="avgResponse">150ms</div>
            <div class="performance-label">Avg Response</div>
          </div>
          <div class="performance-metric">
            <div class="performance-value" id="uptime">99.9%</div>
            <div class="performance-label">Uptime</div>
          </div>
          <div class="performance-metric">
            <div class="performance-value" id="activeUrls">-</div>
            <div class="performance-label">Active URLs</div>
          </div>
        </div>
      </div>
    </div>

    <div class="urls-section">
      <div class="controls">
        <div class="controls-left">
          <h2>üîó All URLs Analytics</h2>
          <select class="filter-select" id="sourceFilter">
            <option value="">All Sources</option>
            <option value="api">API Created</option>
            <option value="web">Web Created</option>
          </select>
        </div>
        <div class="controls-right">
          <input
            type="text"
            id="searchBox"
            class="search-box"
            placeholder="üîç Search URLs, codes, or domains..."
          />
          <button class="btn" onclick="loadData()">
            <span id="refreshIcon">üîÑ</span> Refresh
          </button>
          <button class="btn btn-secondary" onclick="exportData()">
            üì§ Export CSV
          </button>
        </div>
      </div>

      <div id="loadingIndicator" class="loading">Loading analytics data</div>

      <div id="urlsContainer" style="display: none">
        <table class="url-table" id="urlTable">
          <thead>
            <tr>
              <th>Short Code</th>
              <th>Original URL</th>
              <th>Clicks</th>
              <th>Created</th>
              <th>Source</th>
              <th>Top Platform</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="urlTableBody"></tbody>
        </table>

        <div class="pagination" id="pagination" style="display: none"></div>
      </div>

      <div id="emptyState" class="empty-state" style="display: none">
        <h3>üì≠ No URLs Found</h3>
        <p>
          No URLs match your current filters. Try adjusting your search
          criteria.
        </p>
      </div>
    </div>

    <div id="copyNotification" class="copy-notification">
      ‚úÖ Copied to clipboard!
    </div>

    <script>
      let currentPage = 1;
      let totalPages = 1;
      let searchTimeout;
      let allUrlsData = [];
      let baseUrl = "";
      let refreshInterval;

      // Platform icons mapping
      const platformIcons = {
        ios: "#007AFF",
        android: "#3DDC84",
        desktop: "#0078D4",
        mac: "#000000",
        mobile: "#FF6B6B",
        unknown: "#6c757d",
      };

      // Load system statistics
      async function loadSystemStats() {
        try {
          const response = await fetch("/admin/api/v1/system/stats");
          const stats = await response.json();

          document.getElementById("totalUrls").textContent = formatNumber(
            stats.total_urls || 0
          );
          document.getElementById("totalClicks").textContent = formatNumber(
            stats.total_clicks || 0
          );
          document.getElementById("urlsToday").textContent = formatNumber(
            stats.urls_today || 0
          );
          document.getElementById("clicksToday").textContent = formatNumber(
            stats.clicks_today || 0
          );
          document.getElementById("urlsWithApi").textContent = formatNumber(
            stats.urls_with_api_key || 0
          );
          document.getElementById("urlsWithoutApi").textContent = formatNumber(
            stats.urls_without_api_key || 0
          );

          // Update performance metrics
          document.getElementById("activeUrls").textContent = formatNumber(
            stats.urls_with_api_key + stats.urls_without_api_key
          );

          // Render platform chart
          renderPlatformChart(stats.top_platforms || {});
        } catch (error) {
          console.error("Error loading system stats:", error);
        }
      }

      // Load URLs analytics data
      async function loadUrlsAnalytics(page = 1) {
        try {
          document.getElementById("loadingIndicator").style.display = "block";
          document.getElementById("urlsContainer").style.display = "none";
          document.getElementById("emptyState").style.display = "none";

          const response = await fetch(
            `/admin/api/v1/urls/analytics?page=${page}&limit=25`
          );
          const data = await response.json();

          if (response.ok) {
            currentPage = data.pagination.page;
            totalPages = data.pagination.total_pages;
            allUrlsData = data.data;
            baseUrl = data.base_url || window.location.origin;

            if (data.data.length === 0) {
              document.getElementById("emptyState").style.display = "block";
            } else {
              renderUrlsTable(data.data);
              renderPagination();
              document.getElementById("urlsContainer").style.display = "block";
            }
          } else {
            alert("Error loading data: " + data.error);
          }
        } catch (error) {
          alert("Error: " + error.message);
        } finally {
          document.getElementById("loadingIndicator").style.display = "none";
        }
      }

      // Render URLs table
      function renderUrlsTable(urls) {
        const tbody = document.getElementById("urlTableBody");
        tbody.innerHTML = urls
          .map((url) => {
            const topPlatform = getTopPlatform(url.platform_stats);
            const shortUrl = `${baseUrl}/${url.code}`;
            const createdDate = new Date(url.created_at);
            const isRecent =
              Date.now() - createdDate.getTime() < 24 * 60 * 60 * 1000; // Less than 24 hours

            return `
                    <tr ${isRecent ? 'style="background: #fff3cd;"' : ""}>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="url-code">${url.code}</span>
                                <button class="copy-btn" onclick="copyText('${shortUrl}')" title="Copy short URL">üìã</button>
                                ${
                                  isRecent
                                    ? '<span style="font-size: 12px;">üÜï</span>'
                                    : ""
                                }
                            </div>
                        </td>
                        <td>
                            <div class="url-original" title="${
                              url.original_url
                            }">
                                ${url.original_url}
                            </div>
                        </td>
                        <td>
                            <span class="click-count">${formatNumber(
                              url.click_count
                            )}</span>
                        </td>
                        <td>
                            ${formatDate(url.created_at)}
                        </td>
                        <td>
                            ${
                              url.created_by_api
                                ? `<span class="api-badge">üîë API</span>`
                                : `<span class="web-badge">üåê Web</span>`
                            }
                        </td>
                        <td>
                            <div class="platform-stats">
                                <strong>${topPlatform.name}</strong>
                                <span style="color: #007bff;">${
                                  topPlatform.count
                                } clicks</span>
                            </div>
                        </td>
                        <td>
                            <div class="action-links">
                                <a href="/dashboard?code=${
                                  url.code
                                }" target="_blank" title="View detailed analytics">üìä Details</a>
                                <a href="javascript:void(0)" onclick="copyText('${shortUrl}')" title="Copy short URL">üìã Copy</a>
                                <a href="${shortUrl}" target="_blank" title="Open short URL">üîó Open</a>
                            </div>
                        </td>
                    </tr>
                `;
          })
          .join("");
      }

      // Render platform chart
      function renderPlatformChart(platformStats) {
        const chartContainer = document.getElementById("platformChart");
        const total = Object.values(platformStats).reduce((a, b) => a + b, 0);

        if (total === 0) {
          chartContainer.innerHTML =
            '<p style="text-align: center; color: #6c757d; padding: 20px;">üì≠ No platform data available yet</p>';
          return;
        }

        const sortedPlatforms = Object.entries(platformStats)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 6);

        chartContainer.innerHTML = sortedPlatforms
          .map(([platform, count]) => {
            const percentage = ((count / total) * 100).toFixed(1);
            const platformColor =
              platformIcons[platform.toLowerCase()] || platformIcons.unknown;

            return `
                    <div class="chart-item">
                        <div class="chart-label">
                            <div class="platform-icon" style="background: ${platformColor};"></div>
                            ${capitalizeFirst(platform)}
                        </div>
                        <div class="chart-bar">
                            <div class="chart-fill" style="width: ${percentage}%; background: linear-gradient(90deg, ${platformColor}, ${platformColor}dd);"></div>
                        </div>
                        <div class="chart-value">${formatNumber(
                          count
                        )} (${percentage}%)</div>
                    </div>
                `;
          })
          .join("");
      }

      // Render pagination
      function renderPagination() {
        const pagination = document.getElementById("pagination");

        if (totalPages <= 1) {
          pagination.style.display = "none";
          return;
        }

        pagination.style.display = "flex";

        let buttons = [];

        // Previous button
        buttons.push(`
                <button onclick="loadUrlsAnalytics(${currentPage - 1})" ${
          currentPage <= 1 ? "disabled" : ""
        }>
                    ‚Üê Previous
                </button>
            `);

        // Page numbers
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);

        if (startPage > 1) {
          buttons.push(`<button onclick="loadUrlsAnalytics(1)">1</button>`);
          if (startPage > 2) {
            buttons.push(`<button disabled>...</button>`);
          }
        }

        for (let i = startPage; i <= endPage; i++) {
          const activeClass = i === currentPage ? "active" : "";
          buttons.push(`
                    <button class="${activeClass}" onclick="loadUrlsAnalytics(${i})">
                        ${i}
                    </button>
                `);
        }

        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            buttons.push(`<button disabled>...</button>`);
          }
          buttons.push(
            `<button onclick="loadUrlsAnalytics(${totalPages})">${totalPages}</button>`
          );
        }

        // Next button
        buttons.push(`
                <button onclick="loadUrlsAnalytics(${currentPage + 1})" ${
          currentPage >= totalPages ? "disabled" : ""
        }>
                    Next ‚Üí
                </button>
            `);

        pagination.innerHTML = buttons.join("");
      }

      // Search functionality
      document.getElementById("searchBox").addEventListener("input", (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          filterUrls();
        }, 300);
      });

      // Source filter
      document.getElementById("sourceFilter").addEventListener("change", () => {
        filterUrls();
      });

      // Filter URLs based on search and source
      function filterUrls() {
        const searchTerm = document
          .getElementById("searchBox")
          .value.toLowerCase();
        const sourceFilter = document.getElementById("sourceFilter").value;

        let filteredData = allUrlsData;

        if (searchTerm) {
          filteredData = filteredData.filter(
            (url) =>
              url.code.toLowerCase().includes(searchTerm) ||
              url.original_url.toLowerCase().includes(searchTerm) ||
              extractDomain(url.original_url).toLowerCase().includes(searchTerm)
          );
        }

        if (sourceFilter) {
          filteredData = filteredData.filter((url) => {
            if (sourceFilter === "api") return url.created_by_api;
            if (sourceFilter === "web") return !url.created_by_api;
            return true;
          });
        }

        if (filteredData.length === 0) {
          document.getElementById("urlsContainer").style.display = "none";
          document.getElementById("emptyState").style.display = "block";
        } else {
          renderUrlsTable(filteredData);
          document.getElementById("urlsContainer").style.display = "block";
          document.getElementById("emptyState").style.display = "none";
          // Hide pagination when filtering
          document.getElementById("pagination").style.display = "none";
        }
      }

      // Export data to CSV
      function exportData() {
        const csvContent = generateCSV(allUrlsData);
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.style.display = "none";
        a.href = url;
        a.download = `kamero-url-analytics-${
          new Date().toISOString().split("T")[0]
        }.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showCopyNotification("üì§ CSV exported successfully!");
      }

      // Generate CSV content
      function generateCSV(data) {
        const headers = [
          "Short Code",
          "Short URL",
          "Original URL",
          "Click Count",
          "Created Date",
          "Created Time",
          "Source",
          "Top Platform",
          "Platform Clicks",
        ];
        const rows = data.map((url) => {
          const topPlatform = getTopPlatform(url.platform_stats);
          const createdDate = new Date(url.created_at);
          return [
            url.code,
            `${baseUrl}/${url.code}`,
            url.original_url,
            url.click_count,
            createdDate.toLocaleDateString(),
            createdDate.toLocaleTimeString(),
            url.created_by_api ? "API" : "Web",
            topPlatform.name,
            topPlatform.count,
          ];
        });

        return [headers, ...rows]
          .map((row) =>
            row
              .map((field) => `"${String(field).replace(/"/g, '""')}"`)
              .join(",")
          )
          .join("\n");
      }

      // Utility functions
      function formatNumber(num) {
        if (num >= 1000000) {
          return (num / 1000000).toFixed(1) + "M";
        } else if (num >= 1000) {
          return (num / 1000).toFixed(1) + "K";
        }
        return num.toString();
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 1) {
          return (
            "Today " +
            date.toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
            })
          );
        } else if (diffDays === 2) {
          return (
            "Yesterday " +
            date.toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
            })
          );
        } else if (diffDays <= 7) {
          return date.toLocaleDateString("en-US", {
            weekday: "short",
            hour: "2-digit",
            minute: "2-digit",
          });
        } else {
          return date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        }
      }

      function capitalizeFirst(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      function getTopPlatform(platformStats) {
        if (!platformStats || Object.keys(platformStats).length === 0) {
          return { name: "None", count: 0 };
        }

        const [topPlatform, count] = Object.entries(platformStats).reduce(
          (a, b) => (a[1] > b[1] ? a : b)
        );

        return { name: capitalizeFirst(topPlatform), count };
      }

      function extractDomain(url) {
        try {
          return new URL(url).hostname;
        } catch {
          return url;
        }
      }

      // Copy to clipboard
      function copyText(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            showCopyNotification();
          })
          .catch((err) => {
            // Fallback for older browsers
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
              document.execCommand("copy");
              showCopyNotification();
            } catch (err) {
              console.error("Failed to copy: ", err);
              showCopyNotification("‚ùå Failed to copy");
            }

            document.body.removeChild(textArea);
          });
      }

      // Show copy notification
      function showCopyNotification(message = "‚úÖ Copied to clipboard!") {
        const notification = document.getElementById("copyNotification");
        notification.textContent = message;
        notification.classList.add("show");
        setTimeout(() => {
          notification.classList.remove("show");
        }, 2000);
      }

      // Load all data with refresh animation
      function loadData() {
        const refreshIcon = document.getElementById("refreshIcon");
        refreshIcon.innerHTML = '<div class="refresh-indicator"></div>';

        Promise.all([loadSystemStats(), loadUrlsAnalytics(1)]).finally(() => {
          setTimeout(() => {
            refreshIcon.textContent = "üîÑ";
          }, 1000);
        });
      }

      // Setup auto-refresh
      function startAutoRefresh() {
        // Clear existing interval
        if (refreshInterval) {
          clearInterval(refreshInterval);
        }

        // Set up new interval (60 seconds)
        refreshInterval = setInterval(() => {
          loadData();
        }, 60000);
      }

      // Stop auto-refresh when page is not visible
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          if (refreshInterval) {
            clearInterval(refreshInterval);
          }
        } else {
          startAutoRefresh();
          loadData(); // Refresh immediately when page becomes visible
        }
      });

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        // Ctrl/Cmd + R for refresh
        if ((e.ctrlKey || e.metaKey) && e.key === "r") {
          e.preventDefault();
          loadData();
        }

        // Ctrl/Cmd + E for export
        if ((e.ctrlKey || e.metaKey) && e.key === "e") {
          e.preventDefault();
          exportData();
        }

        // Escape to clear search
        if (e.key === "Escape") {
          document.getElementById("searchBox").value = "";
          document.getElementById("sourceFilter").value = "";
          filterUrls();
        }

        // Arrow keys for pagination
        if (e.key === "ArrowLeft" && currentPage > 1) {
          loadUrlsAnalytics(currentPage - 1);
        }
        if (e.key === "ArrowRight" && currentPage < totalPages) {
          loadUrlsAnalytics(currentPage + 1);
        }
      });

      // Initial load and setup
      document.addEventListener("DOMContentLoaded", () => {
        loadData();
        startAutoRefresh();

        // Add focus to search box with slight delay
        setTimeout(() => {
          document.getElementById("searchBox").focus();
        }, 1000);
      });

      // Cleanup on page unload
      window.addEventListener("beforeunload", () => {
        if (refreshInterval) {
          clearInterval(refreshInterval);
        }
      });
    </script>
  </body>
</html>
