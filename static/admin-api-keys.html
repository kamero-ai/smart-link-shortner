<!DOCTYPE html>
<html>
  <head>
    <title>API Keys Management - L.Kamero.ai</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background: #f8f9fa;
        line-height: 1.6;
      }

      .header {
        background: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      }

      .header h1 {
        margin: 0 0 20px 0;
        color: #2c3e50;
        font-size: 2.5rem;
        font-weight: 700;
      }

      .nav-links {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .nav-links a {
        color: #007bff;
        text-decoration: none;
        padding: 12px 20px;
        border-radius: 8px;
        border: 2px solid #007bff;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .nav-links a:hover {
        background: #007bff;
        color: white;
        transform: translateY(-1px);
      }

      .nav-links a.active {
        background: #007bff;
        color: white;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .create-section {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        height: fit-content;
      }

      .api-keys-section {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #007bff;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .btn:hover {
        background: #0056b3;
        transform: translateY(-1px);
      }

      .btn-danger {
        background: #dc3545;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 12px;
      }

      .api-keys-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .api-keys-table th,
      .api-keys-table td {
        padding: 16px 12px;
        text-align: left;
        border-bottom: 1px solid #e1e8ed;
      }

      .api-keys-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #2c3e50;
      }

      .api-keys-table tr:hover {
        background: #f8f9fa;
      }

      .api-key-id {
        font-family: "Monaco", "Consolas", monospace;
        background: #e9ecef;
        padding: 6px 10px;
        border-radius: 6px;
        color: #007bff;
        font-size: 12px;
      }

      .api-key-secret {
        font-family: "Monaco", "Consolas", monospace;
        background: #d1ecf1;
        padding: 6px 10px;
        border-radius: 6px;
        color: #0c5460;
        font-size: 12px;
        word-break: break-all;
      }

      .status-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-active {
        background: #d4edda;
        color: #155724;
      }

      .status-inactive {
        background: #f8d7da;
        color: #721c24;
      }

      .copy-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        margin-left: 8px;
      }

      .copy-btn:hover {
        background: #218838;
      }

      .success-message {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .error-message {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
      }

      .empty-state h3 {
        margin-bottom: 10px;
        color: #6c757d;
      }

      .copy-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 1000;
      }

      .copy-notification.show {
        transform: translateX(0);
      }

      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .nav-links {
          flex-direction: column;
        }

        .api-keys-table {
          font-size: 14px;
        }

        .api-keys-table th,
        .api-keys-table td {
          padding: 12px 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>API Keys Management</h1>
      <div class="nav-links">
        <a href="/admin">üîë API Keys Management</a>
        <a href="/admin/analytics">üìä All URLs Analytics</a>
        <a href="/dashboard">üìà Individual URL Analytics</a>
        <a href="/">üè† URL Shortener</a>
      </div>
    </div>

    <div class="main-content">
      <div class="create-section">
        <h2>Create New API Key</h2>
        <form id="createApiKeyForm">
          <div class="form-group">
            <label for="apiKeyName">API Key Name *</label>
            <input
              type="text"
              id="apiKeyName"
              required
              placeholder="e.g., Mobile App Production"
            />
          </div>
          <div class="form-group">
            <label for="apiKeyDescription">Description</label>
            <textarea
              id="apiKeyDescription"
              placeholder="Optional description for this API key..."
            ></textarea>
          </div>
          <button type="submit" class="btn">Create API Key</button>
        </form>

        <div id="newApiKeyResult" style="display: none">
          <h3>New API Key Created!</h3>
          <div class="success-message">
            <strong>‚ö†Ô∏è Important:</strong> Save these credentials now. The
            secret will only be shown once.
          </div>
          <div class="form-group">
            <label>API Key ID:</label>
            <div style="display: flex; align-items: center">
              <span id="newApiKeyId" class="api-key-id"></span>
              <button class="copy-btn" onclick="copyToClipboard('newApiKeyId')">
                Copy
              </button>
            </div>
          </div>
          <div class="form-group">
            <label>API Key Secret:</label>
            <div style="display: flex; align-items: center">
              <span id="newApiKeySecret" class="api-key-secret"></span>
              <button
                class="copy-btn"
                onclick="copyToClipboard('newApiKeySecret')"
              >
                Copy
              </button>
            </div>
          </div>
          <div class="form-group">
            <label>Full Authorization Header:</label>
            <div style="display: flex; align-items: center">
              <span id="newAuthHeader" class="api-key-secret"></span>
              <button
                class="copy-btn"
                onclick="copyToClipboard('newAuthHeader')"
              >
                Copy
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="api-keys-section">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2>Existing API Keys</h2>
          <button class="btn btn-small" onclick="loadApiKeys()">Refresh</button>
        </div>

        <div id="loadingIndicator" class="loading">Loading API keys...</div>
        <div
          id="errorMessage"
          class="error-message"
          style="display: none"
        ></div>

        <div id="apiKeysContainer">
          <table class="api-keys-table" id="apiKeysTable" style="display: none">
            <thead>
              <tr>
                <th>Key ID</th>
                <th>Name</th>
                <th>Description</th>
                <th>Status</th>
                <th>Created</th>
                <th>Last Used</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="apiKeysTableBody"></tbody>
          </table>

          <div id="emptyState" class="empty-state" style="display: none">
            <h3>No API Keys Found</h3>
            <p>
              Create your first API key to get started with programmatic access.
            </p>
          </div>
        </div>
      </div>
    </div>

    <div id="copyNotification" class="copy-notification">
      Copied to clipboard!
    </div>

    <script>
      // Load API keys on page load
      document.addEventListener("DOMContentLoaded", () => {
        loadApiKeys();
      });

      // Create new API key
      document
        .getElementById("createApiKeyForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const name = document.getElementById("apiKeyName").value;
          const description =
            document.getElementById("apiKeyDescription").value;

          try {
            const response = await fetch("/admin/api/v1/api-keys", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ name, description }),
            });

            const result = await response.json();

            if (response.ok) {
              // Show the new API key details
              document.getElementById("newApiKeyId").textContent =
                result.key_id;
              document.getElementById("newApiKeySecret").textContent =
                result.key_secret;
              document.getElementById(
                "newAuthHeader"
              ).textContent = `Bearer ${result.key_id}:${result.key_secret}`;
              document.getElementById("newApiKeyResult").style.display =
                "block";

              // Clear form
              document.getElementById("createApiKeyForm").reset();

              // Reload API keys list
              loadApiKeys();
            } else {
              alert("Error creating API key: " + result.error);
            }
          } catch (error) {
            alert("Error: " + error.message);
          }
        });

      // Load API keys
      async function loadApiKeys() {
        try {
          document.getElementById("loadingIndicator").style.display = "block";
          document.getElementById("errorMessage").style.display = "none";
          document.getElementById("apiKeysTable").style.display = "none";
          document.getElementById("emptyState").style.display = "none";

          const response = await fetch("/admin/api/v1/api-keys");
          const apiKeys = await response.json();

          if (response.ok) {
            if (apiKeys.length === 0) {
              document.getElementById("emptyState").style.display = "block";
            } else {
              renderApiKeysTable(apiKeys);
              document.getElementById("apiKeysTable").style.display = "table";
            }
          } else {
            showError("Failed to load API keys: " + apiKeys.error);
          }
        } catch (error) {
          showError("Error loading API keys: " + error.message);
        } finally {
          document.getElementById("loadingIndicator").style.display = "none";
        }
      }

      // Render API keys table
      function renderApiKeysTable(apiKeys) {
        const tbody = document.getElementById("apiKeysTableBody");
        tbody.innerHTML = apiKeys
          .map(
            (apiKey) => `
                <tr>
                    <td>
                        <span class="api-key-id">${apiKey.key_id}</span>
                        <button class="copy-btn" onclick="copyText('${
                          apiKey.key_id
                        }')">Copy</button>
                    </td>
                    <td><strong>${apiKey.name}</strong></td>
                    <td>${apiKey.description || "-"}</td>
                    <td>
                        <span class="status-badge ${
                          apiKey.is_active ? "status-active" : "status-inactive"
                        }">
                            ${apiKey.is_active ? "Active" : "Inactive"}
                        </span>
                    </td>
                    <td>${new Date(apiKey.created_at).toLocaleDateString()}</td>
                    <td>${
                      apiKey.last_used_at
                        ? new Date(apiKey.last_used_at).toLocaleDateString()
                        : "Never"
                    }</td>
                    <td>
                        ${
                          apiKey.is_active
                            ? `<button class="btn btn-danger btn-small" onclick="deactivateApiKey('${apiKey.key_id}')">Deactivate</button>`
                            : '<span style="color: #6c757d;">Inactive</span>'
                        }
                    </td>
                </tr>
            `
          )
          .join("");
      }

      // Deactivate API key
      async function deactivateApiKey(keyId) {
        if (
          !confirm(
            "Are you sure you want to deactivate this API key? This action cannot be undone."
          )
        ) {
          return;
        }

        try {
          const response = await fetch(`/admin/api/v1/api-keys/${keyId}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (response.ok) {
            alert("API key deactivated successfully");
            loadApiKeys();
          } else {
            alert("Error deactivating API key: " + result.error);
          }
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      // Copy to clipboard function
      function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        copyText(element.textContent);
      }

      function copyText(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            showCopyNotification();
          })
          .catch((err) => {
            // Fallback for older browsers
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
              document.execCommand("copy");
              showCopyNotification();
            } catch (err) {
              console.error("Failed to copy text: ", err);
            }
            document.body.removeChild(textArea);
          });
      }

      // Show copy notification
      function showCopyNotification() {
        const notification = document.getElementById("copyNotification");
        notification.classList.add("show");
        setTimeout(() => {
          notification.classList.remove("show");
        }, 2000);
      }

      // Show error message
      function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
      }
    </script>
  </body>
</html>
