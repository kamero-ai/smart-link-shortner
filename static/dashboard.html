<!DOCTYPE html>
<html>
  <head>
    <title>URL Analytics Dashboard - L.Kamero.ai</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background: #f8f9fa;
        line-height: 1.6;
      }

      .header {
        background: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      }

      .header h1 {
        margin: 0 0 20px 0;
        color: #2c3e50;
        font-size: 2.5rem;
        font-weight: 700;
      }

      .nav-links {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .nav-links a {
        color: #007bff;
        text-decoration: none;
        padding: 12px 20px;
        border-radius: 8px;
        border: 2px solid #007bff;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .nav-links a:hover {
        background: #007bff;
        color: white;
        transform: translateY(-1px);
      }

      .nav-links a.active {
        background: #007bff;
        color: white;
      }

      .url-input-section {
        background: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      }

      .input-group {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .input-group input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 16px;
        min-width: 300px;
      }

      .input-group input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      }

      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn:hover {
        background: #0056b3;
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-secondary:hover {
        background: #545b62;
      }

      .btn-success {
        background: #28a745;
      }

      .btn-success:hover {
        background: #218838;
      }

      .url-info-card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      }

      .url-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        gap: 20px;
      }

      .url-details {
        flex: 1;
      }

      .short-url {
        font-family: "Monaco", "Consolas", monospace;
        background: #e9ecef;
        padding: 12px 16px;
        border-radius: 8px;
        color: #007bff;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .original-url {
        color: #6c757d;
        word-break: break-all;
        margin-bottom: 15px;
        padding: 10px 0;
        border-bottom: 1px solid #e1e8ed;
      }

      .url-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .meta-item {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .meta-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 5px;
      }

      .meta-label {
        font-size: 0.9rem;
        color: #6c757d;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        text-align: center;
        transition: transform 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #007bff, #0056b3);
      }

      .stat-card:hover {
        transform: translateY(-2px);
      }

      .stat-number {
        font-size: 2.5em;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 8px;
        display: block;
      }

      .stat-label {
        color: #6c757d;
        font-size: 0.95em;
        font-weight: 500;
      }

      .charts-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .chart-card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      }

      .chart-title {
        font-size: 1.3em;
        font-weight: 600;
        margin-bottom: 20px;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .chart-icon {
        width: 24px;
        height: 24px;
        background: #007bff;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
      }

      .chart-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .chart-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
      }

      .chart-label {
        min-width: 80px;
        font-weight: 500;
        color: #2c3e50;
      }

      .chart-bar {
        flex: 1;
        height: 25px;
        background: #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
      }

      .chart-fill {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #0056b3);
        border-radius: 12px;
        transition: width 0.8s ease;
      }

      .chart-value {
        min-width: 60px;
        text-align: right;
        font-weight: 600;
        color: #495057;
      }

      .recent-clicks-section {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      }

      .clicks-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .clicks-table th,
      .clicks-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e1e8ed;
      }

      .clicks-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #2c3e50;
      }

      .clicks-table tr:hover {
        background: #f8f9fa;
      }

      .platform-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: 600;
      }

      .platform-ios {
        background: #007aff;
        color: white;
      }
      .platform-android {
        background: #3ddc84;
        color: white;
      }
      .platform-desktop {
        background: #0078d4;
        color: white;
      }
      .platform-mac {
        background: #000000;
        color: white;
      }
      .platform-mobile {
        background: #ff6b6b;
        color: white;
      }
      .platform-unknown {
        background: #6c757d;
        color: white;
      }

      .copy-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 10px;
        transition: all 0.3s ease;
      }

      .copy-btn:hover {
        background: #218838;
        transform: scale(1.05);
      }

      .loading {
        text-align: center;
        padding: 60px;
        color: #6c757d;
        font-size: 1.1em;
      }

      .loading::after {
        content: "";
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-state {
        text-align: center;
        padding: 60px 20px;
        color: #dc3545;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      }

      .error-state h3 {
        margin-bottom: 10px;
        color: #dc3545;
      }

      .copy-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .copy-notification.show {
        transform: translateX(0);
      }

      .refresh-indicator {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #ffffff;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @media (max-width: 1200px) {
        .charts-section {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .header {
          padding: 20px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .nav-links {
          flex-direction: column;
        }

        .input-group {
          flex-direction: column;
          align-items: stretch;
        }

        .input-group input {
          min-width: auto;
        }

        .url-header {
          flex-direction: column;
        }

        .stats-grid {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .clicks-table {
          font-size: 14px;
        }

        .clicks-table th,
        .clicks-table td {
          padding: 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üìà URL Analytics Dashboard</h1>
      <div class="nav-links">
        <a href="/admin">üîë API Keys Management</a>
        <a href="/admin/analytics">üìä All URLs Analytics</a>
        <a href="/dashboard">üìà Individual URL Analytics</a>
        <a href="/">üè† URL Shortener</a>
      </div>
    </div>

    <div class="url-input-section">
      <h2>üîç Enter Short Code or URL</h2>
      <div class="input-group">
        <input
          type="text"
          id="urlInput"
          placeholder="Enter short code (e.g., abc123) or full short URL (e.g., https://l.kamero.ai/abc123)"
        />
        <button class="btn" onclick="loadAnalytics()" id="analyzeBtn">
          <span>üìä</span> Analyze
        </button>
        <button class="btn btn-secondary" onclick="clearData()" id="clearBtn">
          <span>üóëÔ∏è</span> Clear
        </button>
      </div>
    </div>

    <div id="analyticsContent" style="display: none">
      <div class="url-info-card">
        <div class="url-header">
          <div class="url-details">
            <div class="short-url" id="shortUrlDisplay">
              <span id="shortUrlText"></span>
              <button
                class="copy-btn"
                onclick="copyShortUrl()"
                title="Copy short URL"
              >
                üìã Copy
              </button>
            </div>
            <div class="original-url" id="originalUrlDisplay"></div>
            <div class="url-meta" id="urlMeta">
              <div class="meta-item">
                <div class="meta-value" id="createdDate">-</div>
                <div class="meta-label">Created</div>
              </div>
              <div class="meta-item">
                <div class="meta-value" id="urlSource">-</div>
                <div class="meta-label">Source</div>
              </div>
              <div class="meta-item">
                <div class="meta-value" id="lastClick">-</div>
                <div class="meta-label">Last Click</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalClicks">-</div>
          <div class="stat-label">Total Clicks</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="clicksToday">-</div>
          <div class="stat-label">Clicks Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="uniqueVisitors">-</div>
          <div class="stat-label">Unique Visitors</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avgClicksPerDay">-</div>
          <div class="stat-label">Avg Clicks/Day</div>
        </div>
      </div>

      <div class="charts-section">
        <div class="chart-card">
          <div class="chart-title">
            <div class="chart-icon">üì±</div>
            Platform Distribution
          </div>
          <div class="chart-container" id="platformChart">
            <div class="loading">Loading platform data</div>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-title">
            <div class="chart-icon">üåê</div>
            Browser Distribution
          </div>
          <div class="chart-container" id="browserChart">
            <div class="loading">Loading browser data</div>
          </div>
        </div>
      </div>

      <div class="recent-clicks-section">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <div class="chart-title">
            <div class="chart-icon">üïí</div>
            Recent Clicks
          </div>
          <button
            class="btn btn-success"
            onclick="refreshAnalytics()"
            id="refreshBtn"
          >
            <span id="refreshIcon">üîÑ</span> Refresh
          </button>
        </div>
        <table class="clicks-table" id="clicksTable">
          <thead>
            <tr>
              <th>Time</th>
              <th>Platform</th>
              <th>Browser</th>
              <th>OS</th>
              <th>Location</th>
              <th>Referrer</th>
            </tr>
          </thead>
          <tbody id="clicksTableBody">
            <tr>
              <td colspan="6" class="loading">Loading recent clicks</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="loadingState" class="loading" style="display: none">
      Loading analytics data
    </div>

    <div id="errorState" class="error-state" style="display: none">
      <h3>‚ùå Analytics Not Found</h3>
      <p id="errorMessage">Please check the short code and try again.</p>
      <button class="btn" onclick="clearData()">Try Another URL</button>
    </div>

    <div id="copyNotification" class="copy-notification">
      ‚úÖ Copied to clipboard!
    </div>

    <script>
      let currentCode = "";
      let currentAnalytics = null;
      let baseUrl = "";

      // Get URL parameters on page load
      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");
        const url = urlParams.get("url");

        baseUrl = window.location.origin;

        if (code) {
          document.getElementById("urlInput").value = code;
          loadAnalytics();
        } else if (url) {
          document.getElementById("urlInput").value = url;
          loadAnalytics();
        }

        // Focus on input
        document.getElementById("urlInput").focus();
      });

      // Load analytics for the given code/URL
      async function loadAnalytics() {
        const input = document.getElementById("urlInput").value.trim();
        if (!input) {
          alert("Please enter a short code or URL");
          return;
        }

        // Extract code from input
        const code = extractCodeFromInput(input);
        if (!code) {
          alert("Invalid URL format. Please enter a valid short code or URL.");
          return;
        }

        currentCode = code;

        // Update URL without refresh
        const newUrl = new URL(window.location);
        newUrl.searchParams.set("code", code);
        window.history.replaceState({}, "", newUrl);

        // Show loading state
        showLoadingState();

        try {
          const response = await fetch(`/api/v1/analytics/${code}`);
          const data = await response.json();

          if (response.ok) {
            currentAnalytics = data;
            displayAnalytics(data);
          } else {
            showErrorState(data.error || "Analytics not found");
          }
        } catch (error) {
          showErrorState("Error loading analytics: " + error.message);
        }
      }

      // Extract code from various input formats
      function extractCodeFromInput(input) {
        // If it's just a code (6 characters, alphanumeric)
        if (/^[a-zA-Z0-9]{6}$/.test(input)) {
          return input;
        }

        // If it's a full URL, extract the code
        try {
          const url = new URL(input);
          const pathParts = url.pathname.split("/");
          const code = pathParts[pathParts.length - 1];
          if (/^[a-zA-Z0-9]{6}$/.test(code)) {
            return code;
          }
        } catch (e) {
          // Not a valid URL, try to extract code from end
          const parts = input.split("/");
          const possibleCode = parts[parts.length - 1];
          if (/^[a-zA-Z0-9]{6}$/.test(possibleCode)) {
            return possibleCode;
          }
        }

        return null;
      }

      // Display analytics data
      function displayAnalytics(data) {
        hideAllStates();
        document.getElementById("analyticsContent").style.display = "block";

        // Update URL info
        const shortUrl = `${baseUrl}/${data.code}`;
        document.getElementById("shortUrlText").textContent = shortUrl;
        document.getElementById("originalUrlDisplay").textContent =
          data.original_url;

        // Update metadata
        document.getElementById("createdDate").textContent = formatDate(
          data.created_at
        );
        document.getElementById("urlSource").textContent = data.created_by_api
          ? "üîë API"
          : "üåê Web";

        // Calculate last click
        const lastClick =
          data.recent_clicks && data.recent_clicks.length > 0
            ? formatRelativeTime(new Date(data.recent_clicks[0].clicked_at))
            : "Never";
        document.getElementById("lastClick").textContent = lastClick;

        // Update stats
        document.getElementById("totalClicks").textContent = formatNumber(
          data.click_count
        );

        // Calculate clicks today
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const clicksToday = data.recent_clicks
          ? data.recent_clicks.filter(
              (click) => new Date(click.clicked_at) >= today
            ).length
          : 0;
        document.getElementById("clicksToday").textContent = clicksToday;

        // Calculate unique visitors (simplified - by IP)
        const uniqueIPs = data.recent_clicks
          ? new Set(data.recent_clicks.map((click) => click.ip_address)).size
          : 0;
        document.getElementById("uniqueVisitors").textContent = uniqueIPs;

        // Calculate average clicks per day
        const createdDate = new Date(data.created_at);
        const daysSinceCreated = Math.max(
          1,
          Math.ceil(
            (Date.now() - createdDate.getTime()) / (1000 * 60 * 60 * 24)
          )
        );
        const avgClicksPerDay = (data.click_count / daysSinceCreated).toFixed(
          1
        );
        document.getElementById("avgClicksPerDay").textContent =
          avgClicksPerDay;

        // Render charts
        renderChart("platformChart", data.platform_stats);
        renderChart("browserChart", data.browser_stats);

        // Render recent clicks table
        renderRecentClicksTable(data.recent_clicks || []);
      }

      // Render chart
      function renderChart(containerId, stats) {
        const container = document.getElementById(containerId);
        const total = Object.values(stats).reduce((a, b) => a + b, 0);

        if (total === 0) {
          container.innerHTML =
            '<p style="text-align: center; color: #6c757d; padding: 20px;">üì≠ No data available</p>';
          return;
        }

        const sortedStats = Object.entries(stats)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 8);

        container.innerHTML = sortedStats
          .map(([name, count]) => {
            const percentage = ((count / total) * 100).toFixed(1);
            return `
                    <div class="chart-item">
                        <div class="chart-label">${capitalizeFirst(name)}</div>
                        <div class="chart-bar">
                            <div class="chart-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="chart-value">${formatNumber(
                          count
                        )} (${percentage}%)</div>
                    </div>
                `;
          })
          .join("");
      }

      // Render recent clicks table
      function renderRecentClicksTable(clicks) {
        const tbody = document.getElementById("clicksTableBody");

        if (clicks.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" style="text-align: center; color: #6c757d; padding: 30px;">üì≠ No clicks recorded yet</td></tr>';
          return;
        }

        tbody.innerHTML = clicks
          .slice(0, 20)
          .map((click) => {
            const clickTime = new Date(click.clicked_at);
            const platformClass = `platform-${click.platform.toLowerCase()}`;

            return `
                    <tr>
                        <td>
                            <div style="font-size: 0.9em;">
                                <div>${formatRelativeTime(clickTime)}</div>
                                <div style="color: #6c757d; font-size: 0.8em;">${clickTime.toLocaleString()}</div>
                            </div>
                        </td>
                        <td>
                            <span class="platform-badge ${platformClass}">
                                ${getPlatformIcon(
                                  click.platform
                                )} ${capitalizeFirst(click.platform)}
                            </span>
                        </td>
                        <td>${click.browser || "Unknown"}</td>
                        <td>${click.os || "Unknown"}</td>
                        <td>
                            <div style="font-size: 0.9em;">
                                ${
                                  click.country
                                    ? `üåç ${click.country}`
                                    : "üåç Unknown"
                                }
                                ${
                                  click.city
                                    ? `<div style="color: #6c757d; font-size: 0.8em;">${click.city}</div>`
                                    : ""
                                }
                            </div>
                        </td>
                        <td>
                            <div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${
                              click.referrer || "Direct"
                            }">
                                ${
                                  click.referrer
                                    ? getDomainFromUrl(click.referrer)
                                    : "Direct"
                                }
                            </div>
                        </td>
                    </tr>
                `;
          })
          .join("");
      }

      // Refresh analytics data
      async function refreshAnalytics() {
        if (!currentCode) return;

        const refreshIcon = document.getElementById("refreshIcon");
        refreshIcon.innerHTML = '<div class="refresh-indicator"></div>';

        try {
          const response = await fetch(`/api/v1/analytics/${currentCode}`);
          const data = await response.json();

          if (response.ok) {
            currentAnalytics = data;
            displayAnalytics(data);
            showCopyNotification("üîÑ Analytics refreshed!");
          } else {
            showErrorState(data.error || "Failed to refresh analytics");
          }
        } catch (error) {
          console.error("Error refreshing analytics:", error);
          showCopyNotification("‚ùå Failed to refresh", "error");
        } finally {
          setTimeout(() => {
            refreshIcon.textContent = "üîÑ";
          }, 1000);
        }
      }

      // Copy short URL to clipboard
      function copyShortUrl() {
        if (!currentCode) return;
        const shortUrl = `${baseUrl}/${currentCode}`;
        copyToClipboard(shortUrl);
      }

      // Copy to clipboard
      function copyToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            showCopyNotification();
          })
          .catch((err) => {
            console.error("Failed to copy: ", err);
            showCopyNotification("‚ùå Failed to copy", "error");
          });
      }

      // Show copy notification
      function showCopyNotification(
        message = "‚úÖ Copied to clipboard!",
        type = "success"
      ) {
        const notification = document.getElementById("copyNotification");
        notification.textContent = message;

        if (type === "error") {
          notification.style.background = "#dc3545";
        } else {
          notification.style.background = "#28a745";
        }

        notification.classList.add("show");
        setTimeout(() => {
          notification.classList.remove("show");
        }, 2000);
      }

      // State management
      function showLoadingState() {
        hideAllStates();
        document.getElementById("loadingState").style.display = "block";
      }

      function showErrorState(message) {
        hideAllStates();
        document.getElementById("errorMessage").textContent = message;
        document.getElementById("errorState").style.display = "block";
      }

      function hideAllStates() {
        document.getElementById("analyticsContent").style.display = "none";
        document.getElementById("loadingState").style.display = "none";
        document.getElementById("errorState").style.display = "none";
      }

      // Clear data
      function clearData() {
        document.getElementById("urlInput").value = "";
        currentCode = "";
        currentAnalytics = null;
        hideAllStates();

        // Clear URL parameters
        const newUrl = new URL(window.location);
        newUrl.searchParams.delete("code");
        window.history.replaceState({}, "", newUrl);

        document.getElementById("urlInput").focus();
      }

      // Utility functions
      function formatNumber(num) {
        if (num >= 1000000) {
          return (num / 1000000).toFixed(1) + "M";
        } else if (num >= 1000) {
          return (num / 1000).toFixed(1) + "K";
        }
        return num.toString();
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function formatRelativeTime(date) {
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffMinutes = Math.ceil(diffTime / (1000 * 60));
        const diffHours = Math.ceil(diffTime / (1000 * 60 * 60));
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffMinutes < 60) {
          return diffMinutes === 1 ? "1 min ago" : `${diffMinutes} mins ago`;
        } else if (diffHours < 24) {
          return diffHours === 1 ? "1 hour ago" : `${diffHours} hours ago`;
        } else if (diffDays < 30) {
          return diffDays === 1 ? "1 day ago" : `${diffDays} days ago`;
        } else {
          return date.toLocaleDateString();
        }
      }

      function capitalizeFirst(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      function getPlatformIcon(platform) {
        const icons = {
          ios: "üì±",
          android: "ü§ñ",
          desktop: "üíª",
          mac: "üñ•Ô∏è",
          mobile: "üì±",
          unknown: "‚ùì",
        };
        return icons[platform.toLowerCase()] || icons.unknown;
      }

      function getDomainFromUrl(url) {
        try {
          return new URL(url).hostname;
        } catch {
          return url.substring(0, 30) + (url.length > 30 ? "..." : "");
        }
      }

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        // Enter to analyze
        if (
          e.key === "Enter" &&
          document.activeElement === document.getElementById("urlInput")
        ) {
          loadAnalytics();
        }

        // Ctrl/Cmd + R to refresh
        if ((e.ctrlKey || e.metaKey) && e.key === "r" && currentCode) {
          e.preventDefault();
          refreshAnalytics();
        }

        // Ctrl/Cmd + C to copy short URL
        if ((e.ctrlKey || e.metaKey) && e.key === "c" && currentCode) {
          if (document.activeElement.tagName !== "INPUT") {
            e.preventDefault();
            copyShortUrl();
          }
        }

        // Escape to clear
        if (e.key === "Escape") {
          clearData();
        }
      });

      // Auto-refresh every 30 seconds if analytics are loaded
      setInterval(() => {
        if (currentCode && document.visibilityState === "visible") {
          refreshAnalytics();
        }
      }, 30000);

      // Handle input changes
      document.getElementById("urlInput").addEventListener("input", (e) => {
        const analyzeBtn = document.getElementById("analyzeBtn");
        const clearBtn = document.getElementById("clearBtn");

        if (e.target.value.trim()) {
          analyzeBtn.style.opacity = "1";
          clearBtn.style.opacity = "1";
        } else {
          analyzeBtn.style.opacity = "0.6";
          clearBtn.style.opacity = "0.6";
        }
      });
    </script>
  </body>
</html>
